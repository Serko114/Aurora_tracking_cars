# Траффик авто на фоне Авроры СПб

<a href="https://vkvideo.ru/video-18901857_456254570?ref_domain=guide-spb.fontanka.ru" target="_blank">*Источник видео*</a>

Целью данного репозитория будем считать подсчет машин с выводом в базу данных данных (Windows 10).

## Для этого:

### 1. Обучим модель YOLOv8m, будет включать классификацию (ну тут только один класс, но она есть), детекцию и треккинг.
### 2. Затем определим поле на дороге, при пересечении которого машина будет засчитываться (возможно для точности потребуется несколько полей, т.к. машины перекрывают друг друга время от вмемени).
### 3. Подсоединимся к базе данных.
### 4. Попробуем подсоединить дашборд, может быть типа grafana с выводом статистики через порт в браузер.
### 5. Пока до этого пункта доберемся, еще что-нибудь придумаем ...)

## 1. Обучение модели.
**1.1 Записываем видео с [сайта](https://guide-spb.fontanka.ru/peterburg-veb-kamery "Источник видео") в формате mp.4.**

Заходим на сайт включаем трансляцию, с момощью кнопок _Windows + Alt + R_ создаем видеофайл, от которого и будем плясать. Нужно отметить, что моделька будет хорошо работать в таких же условиях, как на видео, т.е. зима, снег, ночь, огоньки, для иных условий, например день, или лето, потребуется дообучение.

**1.2 Разбиваем видео на кадры, получая картинки в формате png**

Для этого используем программку [FFmpeg](https://ffmpeg.org/download.html).
Чтобы она работала в командной строке, необходимо в "Переменных среды" прописать путь _C:\\ffmpeg\bin_. После этого в командной сроке пишем:
```
ffmpeg -i train.mp4 -vf fps=1.5 images_train/1_img%03d.png
```
>* ffmpeg -  это команда для запуска программы FFmpeg, которая используется для обработки
видео и аудио файлов
>* --i train.mp4 - это опция для указания входного файла train.mp4
>* -vf fps=1.5 - это опция для указания фильтрации видео с заданной частотой кадров в 1.5 кадра
в секунду
>* images_train/img%03d.png - это опция для указания выходной директории и формата имени
файлов, где %03d означает использование трех цифр для нумерации файлов

У меня получилось где-то 250 картинок.

**1.3 Разметка картинок с помощью [CVAT](https://www.cvat.ai/).**

 Очень удобный редактор, в моем случае я его поднял локально, используя [образ Docker](https://docs.cvat.ai/docs/administration/basics/installation/).

Т.к. размечать все картинки очень лень, я разметил около 16-ти картинок, дообучил модель 
YOLOv8m, прогнал всю пачку картинок через модель и получил неплохую разметку, после чего убрал
 лишние боксы, добавил недостающие и уточнил полезные. Далее будет описание обработки основной 
 парии картинок, но такую стратегию надо брать и для обучения предварительных 16-ти картинок.

 > > ! При экспорте размеченных картинок из CVAT нужно выбрать формат YOLO 1.1

**1.3 Разметка картинок с помощью [CVAT](https://www.cvat.ai/).**










![Traffic statistics 1](trim-video.gif)
